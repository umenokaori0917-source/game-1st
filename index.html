<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¨˜æ†¶äº¤éŒ¯ - Webä¹™å¥³ãƒãƒ™ãƒ«ï¼ˆåŠ¹æœéè¡¨ç¤ºç‰ˆï¼æ—¢èª­SKIPï¼†è‡ªå‹•é€ã‚Šï¼‰</title>
<style>
  :root{
    --bg:#0f1116;--panel:#171a22;--ink:#e8ecf1;--sub:#a6b0be;--accent:#7aa2f7;--warn:#f7768e
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.7 system-ui,-apple-system,"Segoe UI",Roboto}
  #app{max-width:880px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  header h1{font-size:18px;margin:0;color:var(--ink)}
  header .mini{color:var(--sub);font-size:12px}
  #stage{background:var(--panel);border:1px solid #22252e;border-radius:12px;min-height:320px;padding:18px;margin-top:12px;position:relative}
  .name{font-weight:700;color:var(--accent);margin-bottom:6px}
  .text{white-space:pre-wrap}
  #choices{margin-top:16px;display:grid;gap:10px}
  button.choice{background:#22283a;color:var(--ink);border:none;padding:12px;border-radius:10px;text-align:left}
  button.choice[disabled]{opacity:.55}
  #ui{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  #ui button,#ui .seg{background:#263146;border:1px solid #2f3950;color:var(--ink);padding:8px 10px;border-radius:8px}
  #ui .seg{display:flex;align-items:center;gap:8px}
  #ui input[type="range"]{width:140px}
  #log{margin-top:12px;color:var(--sub);background:#12141a;border-radius:10px;padding:10px;max-height:160px;overflow:auto;font-size:13px}
  #badges{margin-top:8px;font-size:12px;color:var(--sub)}
  .pill{display:inline-block;border:1px solid #2f3950;border-radius:999px;padding:2px 8px;margin:2px}
  a{color:var(--accent);text-decoration:none}
  .sep{opacity:.5;margin:0 6px}
  .mark-read{position:absolute;right:12px;top:10px;font-size:12px;color:var(--sub);opacity:.8}
  .unread{color:var(--warn);font-weight:700}
  .toggle-on{outline:2px solid var(--accent)}
  /* === è»Œè·¡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— === */
  #journalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:50}
  #journalModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(880px,92vw);max-height:80vh;overflow:auto;display:none;z-index:51;
    background:var(--panel);border:1px solid #2f3950;border-radius:12px;padding:16px}
  #journalModal h2{margin:0 0 8px 0;font-size:18px;color:var(--ink)}
  #journalModal .grid{display:grid;grid-template-columns:1fr;gap:12px}
  #journalModal section{background:#12141a;border:1px solid #2f3950;border-radius:10px;padding:12px}
  #journalModal .row{display:flex;justify-content:space-between;gap:8px}
  #journalModal .close{position:sticky;top:0;margin-left:auto;background:#263146;border:1px solid #2f3950;
    color:var(--ink);padding:6px 10px;border-radius:8px}
  #journalModal ul{margin:6px 0 0 16px}
  #journalModal table{width:100%;border-collapse:collapse;font-size:14px}
  #journalModal td{border-top:1px solid #2f3950;padding:6px 4px}
  #journalModal td:first-child{color:var(--sub)}
  /* ç”»é¢ã«ã¯å‡ºã•ãªã„è¦ç´ ã‚’éè¡¨ç¤ºåŒ– */
  #badges{display:none}
  #log{display:none}
</style>
</head>
<body>
<div id="journalBackdrop"></div>
<div id="journalModal" role="dialog" aria-modal="true" aria-label="è»Œè·¡">
  <div class="row" style="margin-bottom:8px">
    <h2>è»Œè·¡</h2>
    <button class="close" id="btnJournalClose">é–‰ã˜ã‚‹ âœ•</button>
  </div>
  <div class="grid">
    <section>
      <div class="row"><strong>éš ã—ã‚­ãƒ£ãƒ©</strong><span id="jrHidden"></span></div>
      <div class="row"><strong>EDé”æˆçŠ¶æ³</strong><span id="jrEDCount"></span></div>
    </section>
    <section>
      <strong>å…¥æ‰‹ã—ãŸã€Œè¨˜æ†¶ã®æ¬ ç‰‡ã€</strong>
      <ul id="jrFragments"></ul>
    </section>
    <section>
      <strong>ã‚­ãƒ£ãƒ©åˆ¥å¥½æ„Ÿåº¦</strong>
      <table id="jrAffection"></table>
    </section>
    <section>
      <strong>ãƒ­ã‚°</strong>
      <ul id="jrLogs" style="max-height:260px;overflow:auto;margin-top:6px"></ul>
    </section>
  </div>
</div>
<div id="app">
  <header>
    <h1>è¨˜æ†¶äº¤éŒ¯<span class="mini"> â€” åŠ¹æœéè¡¨ç¤ºï¼Webåˆ†å²ãƒãƒ™ãƒ«</span></h1>
    <div class="mini">v1.1</div>
  </header>

  <div id="stage">
    <div class="mark-read" id="readmark"></div>
    <div class="name" id="speaker"></div>
    <div class="text" id="text"></div>
    <div id="choices"></div>
  </div>

  <div id="ui">
    <button id="btnBack">â—€ï¸ æˆ»ã‚‹</button>
    <button id="btnSkipRead">â­ æ—¢èª­ã‚¹ã‚­ãƒƒãƒ—</button>
    <div class="seg">
      <button id="btnToggleSkip">æ—¢èª­SKIP: OFF</button>
      <span class="mini">ï¼ˆæ—¢èª­ï¼†å˜ä¸€é¸æŠã¯è‡ªå‹•é€²è¡Œï¼‰</span>
    </div>
    <div class="seg">
      <button id="btnAutoplay">è‡ªå‹•é€ã‚Š: OFF</button>
      <label class="mini">é€Ÿåº¦ <input id="speed" type="range" min="800" max="4000" step="100" value="1800"></label>
      <span id="speedVal" class="mini">1.8s</span>
    </div>
    <span class="sep">|</span>
    <button id="btnSave">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
    <button id="btnLoad">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnReset">ğŸ—‘ åˆæœŸåŒ–</button>
    <button id="btnJournal">ğŸ“œ è»Œè·¡</button>
  </div>

  <div id="badges"></div>
  <div id="log" aria-label="backlog"></div>
</div>

<script>
/* =========================================================
   ã‚·ãƒŠãƒªã‚ªå®šç¾©ï¼ˆåŠ¹æœéè¡¨ç¤ºï¼‰
   ========================================================= */
const SCENES = {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¿ã‚¤ãƒˆãƒ«ï¼å…±é€š â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "title": {
    name:"ã‚¿ã‚¤ãƒˆãƒ«",
    text:"â€” è¨˜æ†¶äº¤éŒ¯ â€”\nç¾ä»£ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼Ã—é¸æŠå¼ãƒãƒ™ãƒ«ã€‚\nå…±é€šãƒ«ãƒ¼ãƒˆã‚’é€²ã‚ã€å„ã‚­ãƒ£ãƒ©ã®ãƒ«ãƒ¼ãƒˆã‚’è§£æ”¾ã—ã‚ˆã†ã€‚\næ‹æ„›EDã‚’é›†ã‚ã€è¨˜æ†¶ã®æ¬ ç‰‡ã‚’é›†ã‚ã‚‹ã¨â€”â€”ã€é™å¯‚ã®å£°ã€ãŒç¾ã‚Œã‚‹ã€‚",
    choices: [
      { label:"â–¶ï¸ å…±é€šãƒ«ãƒ¼ãƒˆã‹ã‚‰å§‹ã‚ã‚‹", next:"start" },
      { label:"â–¶ï¸ éš ã—ï¼šé™å¯‚ã®å£°ï¼ˆæ±é›² æ‚ çœŸï¼‰", next:"H1", req: isHiddenUnlocked }
    ]
  },

  "start": {
    name: "æ¾ª",
    text: "â€¦ã¾ãŸåŒã˜å¤¢ã€‚è¦‹çŸ¥ã‚‰ã¬èª°ã‹ã®å£°ãŒã€æ°´åº•ã‹ã‚‰å±Šãã‚ˆã†ã«èƒ¸ã‚’éœ‡ã‚ã›ã‚‹ã€‚ç›®è¦šã‚ã‚‹ã¨ã€æ‰‹ã®ã²ã‚‰ã«æ®‹ã‚‹æ¸©åº¦ã ã‘ãŒç¾å®Ÿã§ã€è¨€è‘‰ã¯æ®‹ã‚‰ãªã„ã€‚ä»Šæ—¥ã¯æ”¾èª²å¾Œã€å›³æ›¸é¤¨ã§åå¹´å‰ã®äº‹ä»¶ã‚’èª¿ã¹ã‚ˆã†ã¨æ€ã†ã€‚ä½•ã‹ãŒã€ãã“ã«ç¹‹ãŒã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹ã€‚",
    choices: [
      { label: "å›³æ›¸é¤¨ã¸å‘ã‹ã†", next: "lib1", setAffection: {"ä¹æ¡": +1}, setFlags:{wentLibrary:true} },
      { label: "ã‚«ãƒ•ã‚§ã§ä¸€æ¯ã¤ã", next: "cafe1", setAffection: {"æœå€‰": +1, "æ¹Š": +1}, setFlags:{wentCafe:true} },
      { label: "ç ”ç©¶å”åŠ›ã®ãƒ¡ãƒ¼ãƒ«ã«è¿”äº‹ã‚’å‡ºã™", next: "mail1", setAffection: {"è—¤å ‚": +1}, setFlags:{repliedMail:true} },
    ],
    onEnter: (s)=>logPush("ã€ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°ã€‘")
  },

  "lib1": {
    name: "æ¾ª",
    text: "é™ã‹ãªç´™ã®åŒ‚ã„ã€‚å¤ã„ç¶´ã˜è¾¼ã¿ã®ç‰‡éš…ã«ã€ã€ç¥ãƒåŸ è¨˜æ†¶æ¶ˆå¤±äº‹ä»¶ã€ã®è¦‹å‡ºã—ãŒé»„ã°ã‚“ã§çœ ã£ã¦ã„ãŸã€‚é ã‚’ã‚ãã‚‹æ‰‹ãŒéœ‡ãˆã‚‹ã€‚èª­ã¿é€²ã‚ã‚‹ã»ã©ã€ç§ã®ä¸­ã®â€œæ—¢è¦–æ„Ÿâ€ã¯è¼ªéƒ­ã‚’å¾—ã¦ã„ãã€‚",
    choices: [
      { label: "ã•ã‚‰ã«èª­ã¿é€²ã‚ã‚‹", next: "lib1_gain", addFragment:"æ¬ ç‰‡01_å¤æ–°è" },
      { label: "æœ¬ã‚’é–‰ã˜ã‚‹", next:"afterIntro" }
    ]
  },
  "lib1_gain": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€è¨˜æ†¶ã®æ¬ ç‰‡ã€‘æ¬ ç‰‡â‘ ã€å¤æ–°èï¼šå¤±ã‚ã‚ŒãŸå­¦ç´šè¨˜éŒ²ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"afterIntro"}]
  },

  "cafe1": {
    name: "æœå€‰",
    text: "ã€Œã‚„ã‚ã€‚â€¦â€¦ç›®ã®ä¸‹ã€å°‘ã—èµ¤ã„ã­ã€‚çœ ã‚Œã¦ãªã„ï¼Ÿã€å†—è«‡ã‚ã‹ã™å£°ã¯è»½ãã€ã‘ã‚Œã©è¦–ç·šã¯ã¾ã£ã™ãã ã€‚ã‚«ãƒƒãƒ—ã«æ˜ ã‚‹è‡ªåˆ†ãŒã€å°‘ã—ã ã‘ä»–äººã«æ€ãˆãŸã€‚",
    choices: [
      { label: "è»½å£ã§è¿”ã™", next:"afterIntro", setAffection:{"æœå€‰":+1} },
      { label: "æ­£ç›´ã«ä½“èª¿ã‚’ä¼ãˆã‚‹", next:"afterIntro", setFlags:{honest:true} }
    ]
  },

  "mail1": {
    name:"è—¤å ‚",
    text:"ã€ã”è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã€‚ç„¡ç†ã®ãªã„ç¯„å›²ã§æ§‹ã‚ãªã„ã‹ã‚‰ã€ã‚ãªãŸã®â€œæ„Ÿã˜ãŸã“ã¨â€ã‚’æ•™ãˆã¦ã»ã—ã„ã€æŸ”ã‚‰ã‹ãªæ–‡é¢ã®å¥¥ã«ã€æ²ˆæ®¿ã™ã‚‹å†·ã‚„ã‚„ã‹ãªå¥½å¥‡å¿ƒãŒè¦‹ãˆãŸã€‚",
    choices:[{label:"ä¸å¯§ã«äº†æ‰¿ã‚’è¿”ã™", next:"afterIntro", setFlags:{agreedResearch:true}}]
  },

  "afterIntro": {
    name: "æ¾ª",
    text: "æ ¡é–€ã‚’å‡ºã‚‹ã¨ã€é»’ã„æ‰‹è¢‹ã®ç”·ãŒé™ã‹ã«ç«‹ã£ã¦ã„ãŸã€‚é¢¨å‘ããŒå¤‰ã‚ã‚‹ã€‚è¦–ç·šãŒåˆã†ã‚ˆã‚Šæ—©ãã€å½¼ã¯ç§ã®åã‚’å‘¼ã¶ã€‚",
    choices: [{ label: "ç«‹ã¡æ­¢ã¾ã‚‹", next: "meetKujou" }]
  },

  "meetKujou": {
    name: "ä¹æ¡",
    text: "ã€ŒæŸŠæ¾ªã•ã‚“ã€‚â€¦â€¦ã‚ãªãŸã®â€œç—‡çŠ¶â€ã«ã¤ã„ã¦ã€è©±ãŒã‚ã‚‹ã€ä½ã„å£°ãŒè¼ªéƒ­ã‚’æãã€‚å½¼ã®çœ¼å·®ã—ã¯æ›‡ã‚Šãªãã€ã ã‹ã‚‰ã“ãæ¯è‹¦ã—ã„ã»ã©ã«æ­£ç¢ºã ã£ãŸã€‚",
    choices: [
      { label: "è©±ã‚’èã", next: "forkPrep", setAffection: {"ä¹æ¡": +1} },
      { label: "æ–­ã£ã¦ç«‹ã¡å»ã‚‹", next: "meetKanade", setFlags:{defendedByKanade:true} }
    ]
  },

  "meetKanade": {
    name: "å¥",
    text: "ã€Œç„¡ç†ã«å¿œã˜ãªãã¦ã„ã„ã€‚â€”â€”ç§ãŒã„ã‚‹ã€è‚©ã«ç½®ã‹ã‚ŒãŸæ‰‹ã¯ç†±ã‚’æŒã£ã¦ã„ã¦ã€å¿ƒæ‹ã‚ˆã‚Šå…ˆã«ä¸å®‰ã‚’é®ã‚ãŸã€‚",
    choices: [{ label: "ç¤¼ã‚’è¨€ã†", next: "forkPrep" }]
  },

  "forkPrep": {
    name: "ã‚·ã‚¹ãƒ†ãƒ ",
    text: "ã€æ”¾èª²å¾Œã€‘å»ƒéƒ¨å®¤ã®å†™çœŸç«‹ã¦ã«è§¦ã‚Œã‚‹ã¨ã€é ã„ç¬‘ã„å£°ãŒä¸€ç¬æµã‚Œè¾¼ã‚€ã€‚ï¼ˆæ¬ ç‰‡â‘¡ï¼‰",
    choices: [{ label: "å†™çœŸç«‹ã¦ã‚’æ‰‹ã«å–ã‚‹", next: "roof", addFragment: "æ¬ ç‰‡02_å†™çœŸç«‹ã¦" }]
  },

  "roof": {
    name: "æ¾ª",
    text: "å±‹ä¸Šã§é¢¨ã«èˆã£ãŸãƒ¡ãƒ¢ã‚’è¿½ã„ã€æ‰‹ã™ã‚Šè¶Šã—ã«æŒ‡å…ˆã§æ´ã‚€ã€‚ï¼ˆæ¬ ç‰‡â‘¢ï¼‰ã€å®Ÿé¨“è¨ˆç”»ï¼šè¢«é¨“è€…M-0ã€ã¨ã„ã†æ´»å­—ãŒã€ç´™ã«æµ…ãæ®‹ã£ã¦ã„ãŸã€‚",
    choices: [{ label: "ãƒ¡ãƒ¢ã‚’ã—ã¾ã†", next: "branch", addFragment: "æ¬ ç‰‡03_å±‹ä¸Šãƒ¡ãƒ¢" }]
  },

  "branch": {
    name: "ã‚·ã‚¹ãƒ†ãƒ ",
    text: "èª°ã®éš£ã§ã€ã“ã®æºã‚‰ãä¸–ç•Œã‚’æ­©ãï¼Ÿï¼ˆå€‹åˆ¥ãƒ«ãƒ¼ãƒˆé–‹å§‹ï¼‰",
    choices: [
      { label: "æœå€‰ æ™ƒã®ã‚‚ã¨ã¸å‘ã‹ã†", next: "A1", req:(s)=> (s.affection["æœå€‰"]||0) >= 2 || s.flags.wentCafe },
      { label: "ä¹æ¡ ç…Œã«ä¼šã„ã«è¡Œã", next: "K1", req:(s)=> (s.affection["ä¹æ¡"]||0) >= 2 || s.flags.wentLibrary },
      { label: "ç¥åŸ æ¹Šã‚’æ¢ã™", next: "M1", req:(s)=> (s.affection["æ¹Š"]||0) >= 2 || s.flags.wentCafe },
      { label: "è—¤å ‚ ç†ä¹…ã®ç ”ç©¶å®¤ã¸", next: "R1", req:(s)=> (s.affection["è—¤å ‚"]||0) >= 2 || s.flags.repliedMail || s.flags.agreedResearch },
      { label: "ç¯ å®® å¥ã¨éã”ã™ï¼ˆå‹æƒ…ï¼‰", next: "N1", req:(s)=> true }
    ]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¹æ¡ï¼ˆK1ã€œK6ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "K1": {
    name:"ä¹æ¡",
    text:"ã€Œç›£è¦–å¯¾è±¡ã¨ã—ã¦ã§ã¯ãªãã€äººã¨ã—ã¦ç¢ºèªã—ãŸã„ã€‚ã‚ãªãŸã¯è‡ªåˆ†ã®åŠ›ã‚’ã©ã†èªè­˜ã—ã¦ã„ã‚‹ï¼Ÿã€æ‰‹è¢‹è¶Šã—ã®è·é›¢ã¯æ­£ç¢ºã§ã€æ®‹é…·ãªã»ã©å„ªã—ã‹ã£ãŸã€‚ç§ã¯è¨€è‘‰ã‚’æ¢ã—ã€ã‚„ã£ã¨ã€æ€–ã„ã€‚ã§ã‚‚æ”¾ã‚Šå‡ºã—ãŸããªã„ã€ã¨å£ã«ã™ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"K2"}]
  },
  "K2": {
    name:"ä¹æ¡",
    text:"ä»»å‹™ã¯â€œå®‰å…¨ç¢ºä¿â€ã€‚ã ãŒå½¼ã¯ã€ç§ã®å¸°ã‚Šé“ã‚’ä¸€æ­©å¾Œã‚ã§æ­©ãã ã‘ã§ã€ä½•ã‚‚å¼·åˆ¶ã—ãªã„ã€‚ãã®ç„¡è¨€ã®å°Šé‡ãŒã€é€†ã«å¢ƒç•Œç·šã‚’ãã£ãã‚Šã¨æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã‚‹ã€‚è§¦ã‚Œãªã„ãŸã‚ã®æ‰‹è¢‹ã€‚å½¼ãŒå®ˆã£ã¦ã„ã‚‹ã®ã¯èª°ã®æ‰‹ã‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"K3"}]
  },
  "K3": {
    name:"æ¾ª",
    text:"é›¨ã®å¤œã€ç ”ç©¶å±€ã®è»ŠãŒç§ã‚’é€£ã‚Œå»ã‚ã†ã¨ã—ãŸç¬é–“ã€ä¹æ¡ã¯è¦å‰‡ã‚’ç ´ã£ãŸã€‚ãƒã‚¶ãƒ¼ãƒ‰ã®èµ¤ãŒè·³ã­ã€ç§ã®è…•ã‚’å¼•ãåŠ›ãŒæ¸©åº¦ã‚’æŒã¤ã€‚ã€è¦å‰‡ã¯äººã‚’å®ˆã‚‹ãŸã‚ã«ã‚ã‚‹ã€‚â€”â€”ã ã‹ã‚‰ä»Šã¯ã€ã‚ãªãŸã‚’å®ˆã‚‹ã€",
    choices:[{label:"ç¶šã‘ã‚‹", next:"K4"}]
  },
  "K4": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"å½¼ã®æ‰‹ã«è§¦ã‚Œã‚‹ã‹ã€å½¼ã®è¦å‰‡ã‚’å°Šé‡ã™ã‚‹ã‹ã€‚",
    choices:[
      {label:"æ‰‹ã«è§¦ã‚Œã‚‹", next:"K5a"},
      {label:"è¦å‰‡ã‚’å°Šé‡ã™ã‚‹", next:"K5b"}
    ]
  },
  "K5a": {
    name:"æ¾ª",
    text:"ç§ã¯æ‰‹è¢‹ã®ç¸ã«æŒ‡ã‚’ã‹ã‘ã€å½¼ã®è¨±å¯ã‚’å¾…ã£ãŸã€‚é•·ã„æ²ˆé»™ã®ã®ã¡ã€ä¹æ¡ã¯è‡ªã‚‰æ‰‹è¢‹ã‚’å¤–ã™ã€‚è§¦ã‚ŒãŸè‚Œã¯é©šãã»ã©ç†±ãã€è–„ã„éœ‡ãˆãŒç§ã®é¼“å‹•ã¨é‡ãªã‚‹ã€‚ã€ã“ã‚Œã¯å„€å¼ã ã€‚éå»ã‚’èµ¦ã™ãŸã‚ã®ã€",
    choices:[{label:"ç¶šã‘ã‚‹", next:"K6a"}]
  },
  "K6a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€æ‹æ„›EDï¼šèµ¦ã—ã€‘äºŒäººã¯è§¦ã‚Œã‚‹ã“ã¨ã‚’å–ã‚Šæˆ»ã—ã€è¦å‰‡ã®å¤–ã«å°ã•ãªé¿é›£æ‰€ã‚’ä½œã£ãŸã€‚ä¸–ç•Œã¯å¤‰ã‚ã‚‰ãªã„ãŒã€å‘¼å¸ã¯ç¢ºã‹ã«è»½ããªã‚‹ã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Kujou_Love:true}}]
  },
  "K5b": {
    name:"æ¾ª",
    text:"ç§ã¯ä¸€æ­©ä¸‹ãŒã‚Šã€å½¼ã®â€œæ­£ã—ã•â€ã‚’é¸ã¶ã€‚ã€ã‚ãªãŸãŒå®ˆã£ã¦ããŸã‚‚ã®ã‚’å£Šã—ãŸããªã„ã€ä¹æ¡ã¯é ·ãã€å±€ã®ä¸æ­£ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å·®ã—å‡ºã—ãŸã€‚ã€ä¸€ç·’ã«çµ‚ã‚ã‚‰ã›ã‚ˆã†ã€",
    choices:[{label:"ç¶šã‘ã‚‹", next:"K6b"}]
  },
  "K6b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€çœŸå®ŸEDã€‘å†…éƒ¨å‘Šç™ºã¯æ³¢ç´‹ã‚’åºƒã’ã€è¨ˆç”»ã¯å‡çµã•ã‚ŒãŸã€‚äºŒäººã¯è·é›¢ã‚’æ®‹ã—ã¤ã¤ã€åŒã˜æ–¹å‘ã‚’è¦‹ã¦æ­©ãã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Kujou_Truth:true}}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœå€‰ï¼ˆA1ã€œA6ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "A1": {
    name:"æœå€‰",
    text:"ã€Œå›ã€æ™‚ã€…ã™ã”ãé ãã‚’è¦‹ã¦ã‚‹é¡”ã‚’ã™ã‚‹ã‚ˆã­ã€è»½å£ã®è£ã§ã€å½¼ã¯äººã®è¡¨æƒ…ã®ç¶»ã³ã‚’æ­£ç¢ºã«æ‹¾ã†ã€‚å˜˜ã‚’è¦‹æŠœãç›®ã¯ã€å„ªã—ã•ã§åŒ…ã‚“ã§è¦‹ãˆãªãã—ã¦ãã‚Œã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"A2"}]
  },
  "A2": {
    name:"æ¾ª",
    text:"ç§ã®åŠ›ã‚’æ‰“ã¡æ˜ã‘ã‚‹ã¨ã€æœå€‰ã¯æ·±ãæ¯ã‚’åã„ãŸã€‚ã€Œãã£ã‹ã€‚â€”â€”å®Ÿã¯ã•ã€ä¿ºã‚‚ã€äººãŒã¤ãå˜˜ãŒå…‰ã£ã¦è¦‹ãˆã‚‹ã‚“ã ã€å½¼ã®ç¬‘é¡”ã®è¼ªéƒ­ãŒã€å°‘ã—ã ã‘æ»²ã‚“ã§è¦‹ãˆãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"A3"}]
  },
  "A3": {
    name:"æœå€‰",
    text:"ã€Œæœ¬éŸ³ã£ã¦ã€æ™‚ã€…æ®‹é…·ã ã‚ˆã€‚ã ã‹ã‚‰ä¿ºã¯ã€å®ˆã‚‹ãŸã‚ã®å˜˜ã‚’é¸ã¶ã€å½¼ãŒå·®ã—å‡ºã—ãŸã®ã¯ã€è»½ã„å†—è«‡ã®å½¢ã‚’ã—ãŸç›¾ã€‚ç§ã¯ã€ãã®ç›¾ã®å†…å´ã«èº«ã‚’å¯„ã›ãŸããªã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"A4"}]
  },
  "A4": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"å½¼ã®å˜˜ã‚’å—ã‘å…¥ã‚Œã‚‹ã‹ã€æœ¬éŸ³ã‚’æ±‚ã‚ã‚‹ã‹ã€‚",
    choices:[
      {label:"å—ã‘å…¥ã‚Œã‚‹", next:"A5a"},
      {label:"æœ¬éŸ³ã‚’æ±‚ã‚ã‚‹", next:"A5b"}
    ]
  },
  "A5a": {
    name:"æ¾ª",
    text:"ã€Œã‚ãªãŸãŒè‹¦ã—ããªã„ãªã‚‰ã€ãã®å˜˜ã”ã¨æŠ±ãã—ã‚ãŸã„ã€å‘Šã’ã‚‹ã¨ã€æœå€‰ã¯ç…§ã‚ŒãŸã‚ˆã†ã«ç¬‘ã„ã€çœŸé¡”ã§ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨è¨€ã£ãŸã€‚ä»®é¢ã¯å¤–ã•ãšã«ã€ã§ã‚‚ç¢ºã‹ã«è·é›¢ã¯ç¸®ã¾ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"A6a"}]
  },
  "A6a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€æ‹æ„›EDã€‘â€œå®ˆã‚‹ãŸã‚ã®å˜˜â€ã¯äºŒäººã®åˆè¨€è‘‰ã«ãªã£ãŸã€‚çœŸå®Ÿã¯æ€¥ãŒãšã€è‚©ã‚’ä¸¦ã¹ã‚‹æ—¥ã€…ãŒç¶šã„ã¦ã„ãã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Asakura_Love:true}}]
  },
  "A5b": {
    name:"æœå€‰",
    text:"ã€Œæ€–ã„ã‘ã©ã€é€ƒã’ãªã„ã€‚å›ãŒãã†è¨€ã†ãªã‚‰ã€å½¼ã®å£°ã¯å°ã•ãéœ‡ãˆã€ã—ã‹ã—æ¾„ã‚“ã§ã„ãŸã€‚å˜˜ã®å¹•ãŒä¸€æšã ã‘ã€é™ã‹ã«é™ã‚Šã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"A6b"}]
  },
  "A6b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€å‹æƒ…EDã€‘äºŒäººã¯ç´ é¡”ã‚’äº¤æ›ã—ã€æ‹ã«æ€¥ãŒãšå‹ã§ã„ã‚‹é“ã‚’é¸ã‚“ã ã€‚ç¬‘ã„åˆã†å£°ã¯ã€ä»¥å‰ã‚ˆã‚Šã‚‚æ·±ã„ã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Asakura_Friend:true}}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¹Šï¼ˆM1ã€œM6ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "M1": {
    name:"æ¹Š",
    text:"è·¯åœ°è£ã§è‚©ã‚’åº‡ã†å½¼ã®æ‰‹ã¯ã€è¡€ã®åŒ‚ã„ã¨æ´—å‰¤ã®åŒ‚ã„ãŒæ··ã˜ã£ã¦ã„ãŸã€‚ã€Œè¦‹ã‚“ãªã€‚å¹³æ°—ã€å¼·ãŒã‚Šã®èŠ¯ã«ã€çœŸã£ç›´ããªæ­£ç¾©æ„ŸãŒåˆºã•ã£ã¦ã„ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"M2"}]
  },
  "M2": {
    name:"æ¾ª",
    text:"æ•£ã‚‰ã‹ã£ãŸå°æ‰€ã§ã€ç§ã¯å‹æ‰‹ã«å‘³å™Œæ±ã‚’ä½œã£ãŸã€‚æ¹Šã¯ä¸æº€ãã†ã«çœ‰ã‚’å¯„ã›ã€çµå±€ãŠã‹ã‚ã‚Šã‚’ã—ãŸã€‚æ¹¯æ°—ã®å‘ã“ã†ã«ã€ã‚„ã£ã¨ç¬‘é¡”ãŒè¦‹ãˆã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"M3"}]
  },
  "M3": {
    name:"æ¹Š",
    text:"å€Ÿé‡‘çµ¡ã¿ã®é€£ä¸­ãŒåº—å…ˆã«ç¾ã‚Œã€å½¼ã¯ç§ã‚’èƒŒã«åº‡ã£ãŸã€‚ã€Œé€ƒã’ã­ãˆã‚ˆã€‚ã“ã“ã€ã‚ªãƒ¬ã®å ´æ‰€ã ã‹ã‚‰ã€éœ‡ãˆã¯ã€è†ã§ã¯ãªãå£°ã®å¥¥ã«ã‚ã£ãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"M4"}]
  },
  "M4": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"é€ƒã’ãšã«ç«‹ã¤ã‹ã€å¤§äººã®åŠ©ã‘ã‚’å€Ÿã‚Šã‚‹ã‹ã€‚",
    choices:[
      {label:"é€ƒã’ãªã„", next:"M5a"},
      {label:"åŠ©ã‘ã‚’æ±‚ã‚ã‚‹", next:"M5b"}
    ]
  },
  "M5a": {
    name:"æ¾ª",
    text:"ç§ã¯å½¼ã®éš£ã§ç«‹ã£ãŸã€‚æ€–ã•ã‚’æ­£ç›´ã«è¨€è‘‰ã«ã™ã‚‹ã¨ã€æ¹Šã¯å°‘ã—ã ã‘è‚©ã®åŠ›ã‚’æŠœã„ãŸã€‚ã€Œâ€¦â€¦ã‚ã‚ŠãŒã¨ãªã€",
    choices:[{label:"ç¶šã‘ã‚‹", next:"M6a"}]
  },
  "M6a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€æ‹æ„›EDã€‘äºŒäººã§åƒãã€äºŒäººã§ç¬‘ã„ã€äºŒäººã§çœ ã‚‹æœªæ¥ã®è©±ã‚’ã—ãŸã€‚å°ã•ãªç”Ÿæ´»ã¯ã€èª‡ã‚Šã ã£ãŸã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Minato_Love:true}}]
  },
  "M5b": {
    name:"æ¾ª",
    text:"ç§ã¯æ”¯æ´çª“å£ã«é€£çµ¡ã—ã€å½¼ã‚’é€£ã‚Œã¦è¡Œã£ãŸã€‚åŠ©ã‘ã¯æ¥ã˜ã‚ƒãªã„ã¨ä¼ãˆã‚‹ã¨ã€æ¹Šã¯æ²ˆé»™ã®ã‚ã¨ã€ç´ ç›´ã«é ·ã„ãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"M6b"}]
  },
  "M6b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€æ•‘æ¸ˆEDã€‘åˆ¶åº¦ã¨äººã«æ”¯ãˆã‚‰ã‚Œã€å½¼ã¯â€œå±…å ´æ‰€â€ã‚’å–ã‚Šæˆ»ã—ãŸã€‚æ‹ã¯æ·¡ãã€ã—ã‹ã—ç¢ºã‹ãªç¯ã‚Šã ã£ãŸã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Minato_Save:true}}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ è—¤å ‚ï¼ˆR1ã€œR6ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "R1": {
    name:"è—¤å ‚",
    text:"ã€Œå¢ƒç•Œã‚’ç¢ºã‹ã‚ã¾ã—ã‚‡ã†ã€‚æ€–ããªã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚æ­¢ã‚ã‚‹ã€ç™½è¡£ã®è¢–ã¯ä¸å¯§ã«æŠ˜ã‚‰ã‚Œã¦ã„ãŸã€‚è¨€è‘‰ã¯ã‚„ã•ã—ã„ãŒã€è¦–ç·šã¯çµæœã‚’æ¬²ã—ã¦ã„ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"R2"}]
  },
  "R2": {
    name:"æ¾ª",
    text:"å®‰å…¨åŸŸã®å®Ÿé¨“ã¯é™ã‹ã«å§‹ã¾ã‚Šã€é™ã‹ã«é€²ã‚€ã€‚ç§ã¯æ„Ÿã˜ãŸã‚‚ã®ã‚’è¨€è‘‰ã«ã—ã€å½¼ã¯è¨˜éŒ²ã‚’é‡ã­ã‚‹ã€‚å¿ƒæ‹ã®æ³¢å½¢ãŒå‘¼å¸ã‚ˆã‚Šã‚‚æ­£ç›´ã ã¨çŸ¥ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"R3"}]
  },
  "R3": {
    name:"è—¤å ‚",
    text:"ã€Œå›ã®è² è·ã‚’æœ€å°é™ã«ã€ãã†è¨€ã„ãªãŒã‚‰ã€å½¼ã¯å¢ƒç•Œç·šã‚’ä¸€ãƒŸãƒªãšã¤æŠ¼ã—åºƒã’ãŸã€‚ç§ã®ç›®ã®å‰ã§ç†æ€§ã¨æƒ…ãŒå‡è¡¡ã‚’å¤±ã„ã‹ã‘ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"R4"}]
  },
  "R4": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"å½¼ã‚’ä¿¡ã˜ã¦è¸ã¿è¾¼ã‚€ã‹ã€è·é›¢ã‚’ç½®ãã‹ã€‚",
    choices:[
      {label:"è¸ã¿è¾¼ã‚€", next:"R5a"},
      {label:"è·é›¢ã‚’ç½®ã", next:"R5b"}
    ]
  },
  "R5a": {
    name:"æ¾ª",
    text:"ç§ã¯é™ç•Œã‚’è¦‹èª¤ã£ãŸã€‚å…‰ãŒåè»¢ã—ã€è¨˜æ†¶ã®æµ·ã«é£²ã¾ã‚Œã‚‹ç¬é–“ã€å½¼ã¯è‡ªã‚‰ã‚’çŠ ç‰²ã«ã—ã¦ç§ã‚’å¼•ãä¸Šã’ãŸã€‚å½¼ã®å£°ã ã‘ãŒæµ®æ¨™ã ã£ãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"R6a"}]
  },
  "R6a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€å´©å£ŠEDï¼ˆãƒ¡ãƒªãƒ¼ãƒãƒƒãƒ‰ï¼‰ã€‘ç ”ç©¶ã¯æ­¢ã¾ã£ãŸã€‚äºŒäººã¯äº’ã„ã®è²¬ä»»ã®ä¸­ã§ç”Ÿãã‚‹ã“ã¨ã‚’é¸ã¶ã€‚æ„›ã¯æ®‹ã‚Šã€å‚·ã‚‚æ®‹ã‚‹ã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Todo_Collapse:true}}]
  },
  "R5b": {
    name:"æ¾ª",
    text:"ç§ã¯æ‰‹ã‚’ä¸‹ã‚ã—ã€å½¼ã®æ‰‹ã‹ã‚‰ä¸€æ­©é€€ã„ãŸã€‚ã€Œã‚ãªãŸã®ç†æ€§ã‚’ã€å®ˆã‚ŠãŸã„ã€è—¤å ‚ã¯é•·ãæ¯ã‚’åãã€å¾®ç¬‘ã‚“ã ã€‚ã€Œã‚ã‚ŠãŒã¨ã†ã€",
    choices:[{label:"ç¶šã‘ã‚‹", next:"R6b"}]
  },
  "R6b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€æ‹æ„›EDã€‘äº’ã„ã«ãƒ–ãƒ¬ãƒ¼ã‚­ã‚’æŒã¦ãŸã¨ãã€åˆã‚ã¦åŒã˜é€Ÿåº¦ã§æ­©ã‘ãŸã€‚ç ”ç©¶ã¯â€œäººã®ãŸã‚ã«â€æˆ»ã£ã¦ã„ãã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Todo_Love:true}}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¥ï¼ˆå‹æƒ… N1ã€œN6ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "N1": {
    name:"å¥",
    text:"ã€Œå¤§ä¸ˆå¤«ã€‚ç§ãŒåŸºæº–ã«ãªã‚‹ã€ç°¡æ½”ãªè¨€è‘‰ãŒã€ç§ã®ç†±ã‚’ä¸‹ã’ã‚‹ã€‚å½¼å¥³ã¯ã„ã¤ã ã£ã¦ã€å¿…è¦ãªé‡ã ã‘ã®å„ªã—ã•ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"N2"}]
  },
  "N2": {
    name:"æ¾ª",
    text:"æ”¾èª²å¾Œã®ãƒã‚¹åœã€‚å¥ã¯çã—ãè©±ã‚’é€¸ã‚‰ã•ãšã€è‡ªåˆ†ã®å®¶ã®äº‹æƒ…ã‚’è©±ã—ãŸã€‚æœŸé™ã®ã‚ã‚‹ç´„æŸã€‚èƒŒè² ã£ã¦ã„ã‚‹ã‚‚ã®ã®å½¢ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"N3"}]
  },
  "N3": {
    name:"å¥",
    text:"ã€Œã‚‚ã—ä½•ã‹ãŒèµ·ããŸã‚‰ã€ç§ã®ä»£ã‚ã‚Šã«ç¬‘ã£ã¦ã€ä¸å™¨ç”¨ãªé ¼ã¿ã€‚ç§ã¯é¦–ã‚’æŒ¯ã‚Šã€å½¼å¥³ã®æ‰‹ã‚’æ¡ã£ãŸã€‚æ¸©åº¦ã§ã—ã‹ä¼ã‚ã‚‰ãªã„ã“ã¨ãŒã‚ã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"N4"}]
  },
  "N4": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"å½¼å¥³ã‚’ä¿¡ã˜ã¦é€ã‚Šå‡ºã™ã‹ã€å¼•ãæ­¢ã‚ã‚‹ã‹ã€‚",
    choices:[
      {label:"é€ã‚Šå‡ºã™", next:"N5a"},
      {label:"å¼•ãæ­¢ã‚ã‚‹", next:"N5b"}
    ]
  },
  "N5a": {
    name:"æ¾ª",
    text:"ç§ã¯ã€è¡Œã£ã¦ã€ã¨å‘Šã’ãŸã€‚å½¼å¥³ã¯ç¬‘ã„ã€èƒŒã‚’å‘ã‘ã€æŒ¯ã‚Šè¿”ã‚‰ãªã‹ã£ãŸã€‚å¼·ã„äººã®æ­©ãæ–¹ã‚’ã€ç§ã¯ãã®ã¨ãçŸ¥ã£ãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"N6a"}]
  },
  "N6a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€å‹æƒ…/çŠ ç‰²EDã€‘å½¼å¥³ã®é¸ã‚“ã æœªæ¥ã¯é‡ãã€ã—ã‹ã—ç¢ºã‹ã ã£ãŸã€‚æ®‹ã•ã‚ŒãŸç§ãŸã¡ã¯ã€ãã‚Œã§ã‚‚å‰ã‚’å‘ãã“ã¨ã‚’é¸ã¶ã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Kanade_Friend:true}}]
  },
  "N5b": {
    name:"å¥",
    text:"ã€Œã‚ã‹ã£ãŸã€‚ã˜ã‚ƒã‚ä¸€ç·’ã«è€ƒãˆã‚ˆã†ã€å½¼å¥³ã¯æ­©èª¿ã‚’è½ã¨ã—ã€ç§ã®éš£ã«ç«‹ã£ãŸã€‚æ‹ã¨ã¯é•ã†å½¢ã§ã€è·é›¢ãŒçµã³ç›´ã•ã‚Œã‚‹ã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"N6b"}]
  },
  "N6b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€å‹æƒ…EDã€‘åˆ¥é›¢ã¯å›é¿ã•ã‚ŒãŸã€‚ç´„æŸã¯å»¶é•·ç·šã«ç½®ã‹ã‚Œã€ç¬‘ã„å£°ã¯ä»Šã®ã¾ã¾ç¶šã„ã¦ã„ãã€‚",
    choices:[{label:"EDã‚’è¨˜éŒ²ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"ED_Collector", setFlags:{ED_Kanade_Friend2:true}}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ éš ã—ï¼šæ±é›² æ‚ çœŸï¼ˆH1ã€œH4ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "H1": {
    name:"æ‚ çœŸ",
    text:"ã€Œã‚„ã£ã¨æ¥ãŸã­ã€‚ã“ã“ã¯è¨˜æ†¶ã®â€œå¤–å´â€ã€‚å›ãŒé¸ã‚“ã ã©ã®çµæœ«ã‚‚å¦å®šã—ãªã„ã€é™ã‹ãªå ´æ‰€ã€å½¼ã®å£°ã¯ã€æœ€åˆã«å¤¢ã§èã„ãŸæ¸©åº¦ã¨åŒã˜ã ã£ãŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"H2"}]
  },
  "H2": {
    name:"æ¾ª",
    text:"åå¹´å‰ã€ä¸–ç•Œã¯ã²ã¨ã¤ã®å˜˜ã§ç¶ºéº—ã«æ•´ãˆã‚‰ã‚ŒãŸã€‚ç§ã¯è¢«é¨“è€…M-0ã€‚å›â€”â€”æ±é›²æ‚ çœŸã¯ã€ãã®èª¿æ•´å½¹ã€‚â€œå®ˆè­·è€…â€ã¨ã—ã¦ã€å¤±ã‚ã‚ŒãŸè¨˜æ†¶ã®ã¤ãç›®ã‚’ç¸«ã„ç¶šã‘ã¦ããŸã€‚",
    choices:[{label:"ç¶šã‘ã‚‹", next:"H3"}]
  },
  "H3": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ä¸–ç•Œã‚’ä¿®å¾©ã™ã‚‹ã‹ã€ç¾å®Ÿã‚’å—ã‘å…¥ã‚Œã‚‹ã‹ã€‚",
    choices:[
      {label:"ä¸–ç•Œã‚’ä¿®å¾©ã™ã‚‹", next:"H4a"},
      {label:"ç¾å®Ÿã‚’å—ã‘å…¥ã‚Œã‚‹", next:"H4b"}
    ]
  },
  "H4a": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€ãƒˆã‚¥ãƒ«ãƒ¼EDã€‘æ¬ ç‰‡ã¯çŸ›ç›¾ãªãç¹‹ãŒã‚Šã€èª°ã‚‚ä¸Šæ›¸ãã•ã‚Œãªã„ã¾ã¾ç‰©èªã¯åæŸã—ãŸã€‚ç§ãŸã¡ã¯ã‚„ã£ã¨ã€æ­£ã—ã„çœ ã‚Šæ–¹ã‚’çŸ¥ã‚‹ã€‚",
    choices:[{label:"ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"title"}]
  },
  "H4b": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€ãƒ“ã‚¿ãƒ¼ã‚°ãƒƒãƒ‰ã€‘ç¶™ãç›®ã¯ãã®ã¾ã¾ã€ã—ã‹ã—æ‰‹å½“ã¦ã¯æ–½ã•ã‚ŒãŸã€‚ã»ã¤ã‚Œã‚’çŸ¥ã£ã¦ã„ã‚‹è€…ã ã‘ãŒè¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã€é™ã‹ãªå¹¸ç¦ã€‚",
    choices:[{label:"ã‚¿ã‚¤ãƒˆãƒ«ã¸", next:"title"}]
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ EDè¨˜éŒ²ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¾©å¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "ED_Collector": {
    name:"ã‚·ã‚¹ãƒ†ãƒ ",
    text:"ã€EDè¨˜éŒ²ã‚’æ›´æ–°ã€‘å¿…è¦æ¡ä»¶ã‚’æº€ãŸã™ã¨ã€ã‚¿ã‚¤ãƒˆãƒ«ã«ã€é™å¯‚ã®å£°ã€ãŒå‡ºç¾ã—ã¾ã™ã€‚",
    choices:[{label:"ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹", next:"title"}]
  }
};

// éš ã—è§£æ”¾æ¡ä»¶ï¼šæœå€‰/ä¹æ¡/æ¹Š/è—¤å ‚ã®æ‹æ„›ED ï¼‹ æ¬ ç‰‡3ã¤ä»¥ä¸Š
function isHiddenUnlocked(s){
  const needED = s.flags.ED_Asakura_Love && s.flags.ED_Kujou_Love
              && s.flags.ED_Minato_Love && s.flags.ED_Todo_Love;
  const enoughFragments = (s.fragments||[]).length >= 3;
  return needED && enoughFragments;
}

// REPLACE: DEFAULT_STATE ã‚’ã“ã®å†…å®¹ã«å·®ã—æ›¿ãˆ
const DEFAULT_STATE = {
  sceneId: "title",
  flags: { skipReadToggle:false, autoplay:false, autoplayMs:1800 },
  affection: {},
  fragments: [],
  history: [],
  seen: {},     // æ—¢èª­ç®¡ç†
  logs: []      // â˜… è¿½åŠ ï¼šãƒ­ã‚°è“„ç©ï¼ˆç”»é¢ã«ã¯å‡ºã•ãªã„ï¼‰
};

let state = loadState() || structuredClone(DEFAULT_STATE);
const elSpeaker = document.getElementById("speaker");
const elText = document.getElementById("text");
const elChoices = document.getElementById("choices");
const elLog = document.getElementById("log");
const elBadges = document.getElementById("badges");
const elReadmark = document.getElementById("readmark");
const btnBack = document.getElementById("btnBack");
const btnSkipRead = document.getElementById("btnSkipRead");
const btnToggleSkip = document.getElementById("btnToggleSkip");
const btnAutoplay = document.getElementById("btnAutoplay");
const rngSpeed = document.getElementById("speed");
const speedVal = document.getElementById("speedVal");
// ADD: è»Œè·¡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ 
const btnJournal = document.getElementById("btnJournal");
const journalModal = document.getElementById("journalModal");
const journalBackdrop = document.getElementById("journalBackdrop");
const btnJournalClose = document.getElementById("btnJournalClose");

btnJournal.onclick = openJournal;
btnJournalClose.onclick = closeJournal;
journalBackdrop.onclick = closeJournal;
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeJournal(); });
document.getElementById("btnSave").onclick = ()=>{ saveState(); alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ"); };
document.getElementById("btnLoad").onclick = ()=>{ const ok=confirm("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿæœªä¿å­˜ã®é€²è¡Œã¯å¤±ã‚ã‚Œã¾ã™ã€‚"); if(ok){ const s=loadState(); if(s){ state=s; render(); }}};
document.getElementById("btnReset").onclick = ()=>{ const ok=confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ"); if(ok){ state=structuredClone(DEFAULT_STATE); saveState(); render(); }};
btnBack.onclick = back;
btnSkipRead.onclick = skipToNextUnread;
btnToggleSkip.onclick = ()=>{ state.flags.skipReadToggle = !state.flags.skipReadToggle; renderToggles(); render(); saveState(); };
btnAutoplay.onclick = toggleAutoplay;
rngSpeed.oninput = ()=>{ state.flags.autoplayMs = Number(rngSpeed.value); speedVal.textContent = (state.flags.autoplayMs/1000).toFixed(1)+"s"; saveState(); if(state.flags.autoplay){ restartAutoplay(); }};

let autoplayTimer=null;

render();

/* ---------- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---------- */
function render(){
  const sc = SCENES[state.sceneId];
  if(!sc){ return showText("ã‚·ã‚¹ãƒ†ãƒ ","ã‚·ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: "+state.sceneId, []); }

  // onEnter: ä¸€åº¦ã ã‘
  if(!state.flags["_entered_"+state.sceneId] && typeof sc.onEnter==="function"){
    sc.onEnter(state);
    state.flags["_entered_"+state.sceneId] = true;
  }

  // æ—¢èª­ãƒãƒ¼ã‚­ãƒ³ã‚°
  const wasSeen = !!state.seen[state.sceneId];

  // è¡¨ç¤º
  showText(sc.name||"", sc.text||"", buildChoices(sc));

  // æ—¢èª­è¡¨ç¤º
  elReadmark.innerHTML = wasSeen ? "æ—¢èª­" : '<span class="unread">æœªèª­</span>';

  // æ—¢èª­ã‚¹ã‚­ãƒƒãƒ—ï¼šONã‹ã¤æ—¢èª­ã‹ã¤é¸æŠè‚¢ãŒ1ã¤ä»¥ä¸‹ãªã‚‰è‡ªå‹•ã§é€²ã‚€
  if(state.flags.skipReadToggle && wasSeen){
    const validChoices = getValidChoices(sc);
    if(validChoices.length === 1){
      setTimeout(()=>choose(validChoices[0]), 0);
      return;
    }
  }

  // æ—¢èª­ç™»éŒ²
  state.seen[state.sceneId] = true;

  // ãƒãƒƒã‚¸æ›´æ–°
  updateBadges();
  renderToggles();

  // è‡ªå‹•é€ã‚Šï¼šONæ™‚ã¯å˜ä¸€é¸æŠã®ã¿è‡ªå‹•ã€è¤‡æ•°é¸æŠã¯åœæ­¢
  if(state.flags.autoplay){
    scheduleAutoplayStep();
  }

  saveState();
}

function showText(name, text, choiceElems){
  elSpeaker.textContent = name||"";
  elText.textContent = text||"";
  elChoices.innerHTML = "";
  choiceElems.forEach(cfg=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = cfg.label;
    if(cfg.disabled){ btn.disabled = true; }
    btn.onclick = ()=>choose(cfg);
    elChoices.appendChild(btn);
  });
}

/* ---------- é¸æŠè‚¢é–¢é€£ ---------- */
function buildChoices(sc){
  const out=[];
  for(const ch of (sc.choices||[])){
    let ok = true;
    if(ch.req){ try{ ok = !!ch.req(state);}catch(e){ok=false;} }
    out.push({...ch, disabled: !ok});
  }
  return out;
}
function getValidChoices(sc){
  return (sc.choices||[]).filter(ch=>!ch.req || ch.req(state));
}

function choose(ch){
  // åŠ¹æœé©ç”¨ï¼ˆå†…éƒ¨ã®ã¿ï¼‰
  if(ch.setFlags){ Object.assign(state.flags, ch.setFlags); }
  if(ch.setAffection){
    for(const k in ch.setAffection){
      state.affection[k] = (state.affection[k]||0) + ch.setAffection[k];
    }
  }
  if(ch.addFragment){
    if(!state.fragments.includes(ch.addFragment)){
      state.fragments.push(ch.addFragment);
      logPush("ã€æ¬ ç‰‡å…¥æ‰‹ã€‘"+ch.addFragment);
    }
  }
  // æˆ»ã‚‹ç”¨å±¥æ­´
  state.history.push(state.sceneId);
  // é·ç§»
  state.sceneId = ch.next;
  render();
}

function back(){
  const prev = state.history.pop();
  if(prev){ state.sceneId = prev; render(); saveState(); }
}

/* ---------- æ—¢èª­ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¬¡ã®æœªèª­ or åˆ†å²ã¾ã§ï¼‰ ---------- */
function skipToNextUnread(){
  let guard=0;
  while(guard++<200){
    const sc = SCENES[state.sceneId];
    if(!sc) break;

    const seen = !!state.seen[state.sceneId];
    const valid = getValidChoices(sc);

    // æœªèª­ã€ã¾ãŸã¯é¸æŠè‚¢ãŒè¤‡æ•°ã‚ã‚‹ï¼ˆåˆ†å²ç‚¹ï¼‰ãªã‚‰åœæ­¢
    if(!seen || valid.length !== 1){
      render(); // å†æç”»ã ã‘
      return;
    }
    // å˜ä¸€é¸æŠã§æ—¢èª­ â†’ è‡ªå‹•ã§è¸ã‚€
    choose(valid[0]);
  }
}

/* ---------- è‡ªå‹•é€ã‚Š ---------- */
function toggleAutoplay(){
  state.flags.autoplay = !state.flags.autoplay;
  if(state.flags.autoplay){ startAutoplay(); } else { stopAutoplay(); }
  renderToggles(); saveState();
}
function startAutoplay(){
  stopAutoplay();
  scheduleAutoplayStep();
}
function stopAutoplay(){
  if(autoplayTimer){ clearTimeout(autoplayTimer); autoplayTimer=null; }
}
function restartAutoplay(){
  if(state.flags.autoplay){ startAutoplay(); }
}
function scheduleAutoplayStep(){
  stopAutoplay();
  autoplayTimer = setTimeout(autoplayStep, state.flags.autoplayMs||1800);
}
function autoplayStep(){
  const sc = SCENES[state.sceneId];
  if(!sc){ return; }
  const valid = getValidChoices(sc);
  if(valid.length === 1){
    choose(valid[0]);
  }else{
    stopAutoplay(); // åˆ†å²ã§ã¯åœæ­¢
    renderToggles();
  }
}

/* ---------- UI/çŠ¶æ…‹ ---------- */
// REPLACE: updateBadges
function updateBadges(){
  // ä½•ã‚‚è¡¨ç¤ºã—ãªã„ã€‚ä»£ã‚ã‚Šã«è»Œè·¡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’æœ€æ–°åŒ–
  if(journalModal.style.display === "block"){ renderJournal(); }
}

function renderToggles(){
  document.getElementById("btnToggleSkip").textContent = `æ—¢èª­SKIP: ${state.flags.skipReadToggle ? "ON" : "OFF"}`;
  document.getElementById("btnToggleSkip").classList.toggle("toggle-on", !!state.flags.skipReadToggle);
  document.getElementById("btnAutoplay").textContent = `è‡ªå‹•é€ã‚Š: ${state.flags.autoplay ? "ON" : "OFF"}`;
  document.getElementById("btnAutoplay").classList.toggle("toggle-on", !!state.flags.autoplay);
  document.getElementById("speed").value = String(state.flags.autoplayMs||1800);
  document.getElementById("speedVal").textContent = ((state.flags.autoplayMs||1800)/1000).toFixed(1)+"s";
}

// ADD: è»Œè·¡ï¼ˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼‰æç”»
function renderJournal(){
  // éš ã—é–‹æ”¾
  const hidden = isHiddenUnlocked(state);
  document.getElementById("jrHidden").textContent = hidden ? "è§£æ”¾æ¸ˆ" : "æœªè§£æ”¾";

  // EDæ•°
  const edKeys = Object.keys(state.flags).filter(k=>k.startsWith("ED_"));
  document.getElementById("jrEDCount").textContent = `${edKeys.length} ä»¶`;

  // æ¬ ç‰‡
  const frUl = document.getElementById("jrFragments");
  frUl.innerHTML = "";
  if((state.fragments||[]).length===0){
    const li = document.createElement("li"); li.textContent = "æœªå…¥æ‰‹";
    frUl.appendChild(li);
  }else{
    state.fragments.forEach(f=>{
      const li = document.createElement("li"); li.textContent = f; frUl.appendChild(li);
    });
  }

  // å¥½æ„Ÿåº¦
  const afTbl = document.getElementById("jrAffection");
  afTbl.innerHTML = "";
  const entries = Object.entries(state.affection||{});
  if(entries.length===0){
    const tr = document.createElement("tr"); tr.innerHTML = "<td>ãƒ‡ãƒ¼ã‚¿ãªã—</td><td></td>"; afTbl.appendChild(tr);
  }else{
    entries.forEach(([name,val])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td style="text-align:right">${val}</td>`;
      afTbl.appendChild(tr);
    });
  }

  // ãƒ­ã‚°
  const logsUl = document.getElementById("jrLogs");
  logsUl.innerHTML = "";
  if((state.logs||[]).length===0){
    const li = document.createElement("li"); li.textContent = "ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";
    logsUl.appendChild(li);
  }else{
    state.logs.slice(-200).forEach(l=>{
      const li = document.createElement("li"); li.textContent = l; logsUl.appendChild(li);
    });
  }
}

function openJournal(){
  renderJournal();
  journalBackdrop.style.display = "block";
  journalModal.style.display = "block";
}

function closeJournal(){
  journalBackdrop.style.display = "none";
  journalModal.style.display = "none";
}
  
// REPLACE: logPush
function logPush(line){
  const stamp = new Date().toLocaleTimeString()+" "+line;
  state.logs.push(stamp);         // â˜… state ã«è“„ç©
  // æ—§#logã¯éè¡¨ç¤ºã®ãŸã‚DOMè¿½è¨˜ã¯ä¸è¦ã ãŒã€æ—¢å­˜åˆ©ç”¨ã®äº’æ›ã§æ®‹ã™ãªã‚‰ä»¥ä¸‹ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤
  // const p = document.createElement("div");
  // p.textContent = stamp;
  // document.getElementById("log").appendChild(p);
  // document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
}

/* ---------- æ°¸ç¶šåŒ– ---------- */
function saveState(){ localStorage.setItem("mem_novel_state", JSON.stringify(state)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem("mem_novel_state")); }catch(e){ return null; } }
</script>
</body>
</html>
